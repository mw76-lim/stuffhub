<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ì»µ ì…”í”Œ ì•¼ë°”ìœ„ ê²Œì„ (3íšŒ ëˆ„ì  Â· ë‚œì´ë„ ìƒìŠ¹)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }

      :root{
        --bg:#f7f2ea;
        --paper:#fffaf5;
        --ink:#3a2415;
        --muted:#6b4a30;
        --line:rgba(193, 160, 120, 0.5);
        --shadow:0 16px 40px rgba(120, 72, 37, 0.18);
        --shadow-soft:0 10px 26px rgba(120,72,37,.10);
        --radius:24px;
      }

      body{
        min-height: 100vh;
        display: grid;
        place-items: center;
        gap: 12px;
        background: var(--bg);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--ink);
        padding: 16px;
      }

      /* =======================
         MAIN GAME SHELL
      ======================= */
      .game-shell {
        width: 600px;
        height: 450px;
        padding: 16px 16px 14px;
        background: var(--paper);
        border-radius: var(--radius);
        border: 1px solid var(--line);
        box-shadow: var(--shadow);
        overflow: hidden;

        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 10px;
        position: relative;
      }

      /* âœ… resetAllButton: ìƒë‹¨ ìš°ì¸¡ ê³ ì • */
      .top-actions{
        position:absolute;
        top: 12px;
        right: 12px;
        z-index: 5;
      }

      .btn {
        border-radius: 999px;
        padding: 9px 14px;
        font-size: 12px;
        border: 1px solid rgba(148, 104, 63, 0.65);
        background: #fff;
        color: #3a2415;
        font-weight: 800;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: 0.15s ease;
        white-space: nowrap;
      }
      .btn.primary {
        background: linear-gradient(120deg, #f97316, #fbbf24);
        border-color: transparent;
        color: #3b1f0a;
        box-shadow: 0 10px 22px rgba(201, 93, 39, 0.45);
      }
      .btn.ghost { background: rgba(255,255,255,.78); }
      .btn:hover:not([disabled]) {
        transform: translateY(-1px);
        box-shadow: 0 12px 24px rgba(201, 93, 39, 0.5);
      }
      .btn:active:not([disabled]) { transform: translateY(0); box-shadow: none; }
      .btn[disabled] { opacity: 0.6; cursor: default; box-shadow: none; transform:none; }

      .game-header {
        text-align: center;
        display: grid;
        gap: 6px;
        padding-top: 2px;
      }

      .game-title {
        font-size: 18px;
        font-weight: 900;
        letter-spacing: -0.02em;
      }

      .game-sub {
        font-size: 12px;
        color: var(--muted);
        line-height: 1.4;
        margin: 0 auto;
        max-width: 56ch;
      }

      .meta-row{
        display:flex;
        justify-content:center;
        gap:8px;
        flex-wrap:wrap;
      }
      .chip{
        font-size:11px;
        padding:6px 10px;
        border-radius:999px;
        border:1px solid rgba(148, 104, 63, 0.45);
        background: rgba(255,255,255,.7);
        color:#5a3a22;
      }
      .chip strong{ color:#b45309; }

      .table-area {
        padding: 14px 12px 12px;
        border-radius: 18px;
        background: radial-gradient(circle at top, #f4e5d4, #e2c7a8);
        box-shadow: inset 0 3px 8px rgba(255, 255, 255, 0.7);
        position: relative;
        overflow: hidden;

        display:grid;
        grid-template-rows: 1fr auto;
        gap: 10px;
        min-height: 0;
      }

      .cup-stage { position: relative; height: 190px; }

      .cup {
        position: absolute;
        bottom: 20px;
        width: 78px;
        height: 96px;
        border-radius: 56px 56px 16px 16px;
        background: linear-gradient(180deg, #f9f5ef 0, #f1e0cd 40%, #e2c4a0 100%);
        box-shadow:
          0 10px 18px rgba(124, 78, 38, 0.35),
          inset 0 0 0 1px rgba(255, 255, 255, 0.6);
        transform: translateX(-50%);
        transition: left 0.32s ease, transform 0.18s ease, opacity .12s ease;
        cursor: pointer;
      }

      .cup::before {
        content: "";
        position: absolute;
        top: -9px;
        left: 50%;
        transform: translateX(-50%);
        width: 62px;
        height: 11px;
        border-radius: 999px;
        background: radial-gradient(circle at top, #ffffff, #e8d6c0);
        box-shadow: 0 2px 4px rgba(124, 78, 38, 0.25);
      }

      .cup::after {
        content: "";
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        width: 66px;
        height: 10px;
        border-radius: 999px;
        background: rgba(111, 70, 33, 0.45);
        filter: blur(3px);
        opacity: 0.85;
      }

      .cup.is-disabled { cursor: default; opacity: 0.7; }
      .cup.is-highlight {
        box-shadow:
          0 12px 24px rgba(201, 93, 39, 0.55),
          inset 0 0 0 1px rgba(255, 255, 255, 0.7);
      }
      .cup.reveal { transform: translate(-50%, -16px); }

      .ball {
        position: absolute;
        bottom: 20px;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 20%, #ffffff, #e11d48);
        box-shadow:
          0 0 0 3px rgba(120, 46, 60, 0.55),
          0 6px 10px rgba(120, 46, 60, 0.6);
        transform: translateX(-50%);
        opacity: 0;
        transition: left 0.32s ease, opacity 0.2s ease;
        pointer-events: none;
      }
      .ball.visible { opacity: 1; }

      .status-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
        font-size: 12px;
      }

      .status-text {
        color: var(--muted);
        line-height: 1.35;
      }
      .status-text strong { color: #b45309; }

      .footer-row{
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:10px;
        font-size:11px;
        color:#8b6544;
        padding: 0 4px;
      }

      /* =======================
         BELOW: RESULT/REWARD BOX
      ======================= */
      .reward-shell{
        width: 600px;
        background: rgba(255,250,245,.88);
        border-radius: 18px;
        border: 1px solid rgba(193, 160, 120, 0.35);
        box-shadow: var(--shadow-soft);
        padding: 12px;
        display:grid;
        gap: 10px;
      }

      .reward-head{
        display:flex;
        align-items:flex-end;
        justify-content:space-between;
        gap: 10px;
        flex-wrap:wrap;
      }
      .reward-head h3{
        font-size: 13px;
        font-weight: 950;
        letter-spacing: -0.02em;
        color:#5a3a22;
      }
      .reward-head .note{
        font-size: 11px;
        color:#8b6544;
        line-height: 1.35;
      }

      .reward-grid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .reward-card{
        background: rgba(255,255,255,.78);
        border: 1px solid rgba(148,104,63,.22);
        border-radius: 14px;
        padding: 10px;
        display:grid;
        gap: 6px;
      }
      .reward-top{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 8px;
        flex-wrap:wrap;
      }
      .reward-top strong{
        font-size: 12px;
        color:#3a2415;
        letter-spacing: -0.01em;
      }
      .reward-badge{
        font-size: 11px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(148,104,63,.25);
        background: rgba(255,255,255,.9);
        color:#5a3a22;
        font-weight: 900;
        white-space: nowrap;
      }
      .reward-desc{
        font-size: 11.5px;
        color:#6b4a30;
        line-height: 1.35;
      }

      .summary{
        border-radius: 16px;
        border: 1px solid rgba(148,104,63,.22);
        background: rgba(255,255,255,.78);
        padding: 12px;
        display:grid;
        gap: 8px;
      }
      .summary .row{
        display:flex;
        justify-content:space-between;
        gap: 10px;
        font-size: 12px;
        color:#6b4a30;
      }
      .summary .row strong{ color:#b45309; }
      .summary .final{
        font-size: 12px;
        color:#5a3a22;
        line-height: 1.45;
      }

      /* âœ… ê´€ë¦¬ì ì œì¶œ ì˜ì—­ */
      .admin-actions{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 10px;
        flex-wrap:wrap;
      }
      .admin-note{
        font-size: 11px;
        color:#8b6544;
        line-height: 1.35;
      }

      /* =======================
         MODAL
      ======================= */
      .modal-backdrop{
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 18px;
        z-index: 9999;
      }
      .modal-backdrop.is-open{ display: flex; }

      .modal{
        width: min(520px, 100%);
        background: rgba(255,250,245,.96);
        border: 1px solid rgba(193,160,120,.55);
        border-radius: 18px;
        box-shadow: 0 22px 60px rgba(0,0,0,.22);
        overflow: hidden;
        transform: translateY(8px);
        opacity: 0;
        animation: pop .16s ease forwards;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      @keyframes pop{ to { transform: translateY(0); opacity: 1; } }

      .modal-head{
        padding: 14px 14px 10px;
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap: 10px;
        border-bottom: 1px solid rgba(148,104,63,.20);
        background:
          radial-gradient(circle at 12% 0%, rgba(249,115,22,.18), rgba(255,255,255,0) 62%),
          radial-gradient(circle at 92% 10%, rgba(251,191,36,.18), rgba(255,255,255,0) 64%);
      }

      .modal-title{ display:grid; gap:4px; }
      .modal-title h2{ font-size: 14px; font-weight: 900; letter-spacing: -0.02em; }
      .modal-title p{ font-size: 11.5px; color: #6b4a30; line-height: 1.35; }

      .modal-close{
        border: 1px solid rgba(148,104,63,.35);
        background: rgba(255,255,255,.7);
        border-radius: 12px;
        padding: 6px 10px;
        font-size: 12px;
        font-weight: 800;
        cursor: pointer;
      }

      .modal-body{ padding: 12px 14px; display:grid; gap: 10px; }

      .result-box{
        border: 1px solid rgba(148,104,63,.25);
        background: rgba(255,255,255,.72);
        border-radius: 14px;
        padding: 12px;
        display:grid;
        gap: 8px;
      }
      .result-top{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        flex-wrap:wrap;
      }
      .badge{
        font-size: 11px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(148,104,63,.30);
        background: rgba(255,255,255,.8);
        color:#5a3a22;
        font-weight: 800;
        white-space: nowrap;
      }
      .result-text{
        font-size: 12px;
        color: #5b3a22;
        line-height: 1.45;
      }
      .result-text strong{ color:#b45309; }

      .modal-actions{
        display:flex;
        gap: 10px;
        justify-content:flex-end;
        padding: 0 14px 14px;
      }

      /* =======================
         RESPONSIVE
      ======================= */
      @media (max-width: 640px) {
        .game-shell{ width: 100%; height: auto; min-height: 450px; }
        .reward-shell{ width: 100%; }
        .reward-grid{ grid-template-columns: 1fr; }
        .cup-stage{ height: 200px; }
        .status-row{ grid-template-columns: 1fr; }
        .modal-actions{ justify-content: stretch; }
        .modal-actions .btn{ width: 100%; justify-content:center; }

        .admin-actions{ align-items:stretch; }
        .admin-actions .btn{ width:100%; justify-content:center; }
        .admin-note{ text-align:center; width:100%; }
      }
    </style>
  </head>

  <body>
    <div class="game-shell" role="application" aria-label="ì»µ ì…”í”Œ ì•¼ë°”ìœ„ ê²Œì„">
      <!-- âœ… resetAllButton: ìƒë‹¨ ìš°ì¸¡ -->
      <div class="top-actions">
        <button type="button" class="btn ghost" id="resetAllButton">ì „ì²´ ì´ˆê¸°í™” ğŸ”</button>
      </div>

      <header class="game-header">
        <h1 class="game-title">ì»µ ì…”í”Œ ì•¼ë°”ìœ„</h1>
        <p class="game-sub">
          ì´ 3íšŒ ë„ì „! 1â†’2â†’3íšŒì°¨ë¡œ ê°ˆìˆ˜ë¡ ë” ë¹ ë¥´ê³  ë” ë§ì´ ì„ìŠµë‹ˆë‹¤. (3íšŒì°¨ëŠ” ë¯¸ë¼ ë™ì‘ë„ ìˆì–´ìš”)
        </p>
        <div class="meta-row" aria-label="ì§„í–‰ í˜„í™©">
          <div class="chip">íšŒì°¨: <strong id="roundChip">0</strong>/3</div>
          <div class="chip">ì •ë‹µ: <strong id="correctChip">0</strong></div>
          <div class="chip">ë‚¨ì€ íšŸìˆ˜: <strong id="leftChip">3</strong></div>
          <div class="chip">ë‚œì´ë„: <strong id="levelChip">-</strong></div>
        </div>
      </header>

      <section class="table-area" aria-label="ê²Œì„ ì˜ì—­">
        <div class="cup-stage">
          <div class="cup" data-id="0" aria-label="ì™¼ìª½ ì»µ"></div>
          <div class="cup" data-id="1" aria-label="ê°€ìš´ë° ì»µ"></div>
          <div class="cup" data-id="2" aria-label="ì˜¤ë¥¸ìª½ ì»µ"></div>
          <div class="ball" id="ball" aria-hidden="true"></div>
        </div>

        <div class="status-row">
          <div class="status-text" id="statusText">
            <strong>ë¼ìš´ë“œ ì‹œì‘</strong>ì„ ëˆ„ë¥´ë©´ ê³µ ìœ„ì¹˜ë¥¼ ì ê¹ ê³µê°œí•œ ë’¤ ì„ìŠµë‹ˆë‹¤.
          </div>
          <button type="button" class="btn primary" id="startButton">
            ë¼ìš´ë“œ ì‹œì‘ ğŸ©
          </button>
        </div>
      </section>

      <div class="footer-row">
        <div>* 3íšŒ ì¢…ë£Œ í›„, ì •ë‹µ íšŸìˆ˜(0~3)ì— ë”°ë¼ ìµœì¢… ìƒí’ˆì´ ê²°ì •ë©ë‹ˆë‹¤.</div>
        <div></div>
      </div>
    </div>

    <!-- âœ… game-shell ì•„ë˜: ê²°ê³¼ ë° ë³´ìƒ ì•ˆë‚´ -->
    <div class="reward-shell" aria-label="ê²°ê³¼ ë° ë³´ìƒ ì•ˆë‚´">
      <div class="reward-head">
        <h3>ê²°ê³¼ ë° ë³´ìƒ ì•ˆë‚´</h3>
        <div class="note">
          * ìµœì¢… ê²°ê³¼ëŠ” <strong>3íšŒ ì¢…ë£Œ í›„</strong> í™•ì •ë©ë‹ˆë‹¤.<br/>
          * ì§ì›ì—ê²Œ í™”ë©´ì„ ë³´ì—¬ì£¼ë©´ í˜œíƒì´ ì ìš©ë©ë‹ˆë‹¤.
        </div>
      </div>

      <div class="reward-grid" aria-label="ë³´ìƒ ê¸°ì¤€">
        <div class="reward-card">
          <div class="reward-top">
            <strong>ì •ë‹µ 3íšŒ</strong>
            <span class="reward-badge">í¼í™íŠ¸</span>
          </div>
          <div class="reward-desc">ğŸ† ìµœê³ ê¸‰ í˜œíƒ (ì˜ˆ: í”„ë¦¬ë¯¸ì—„ ì„œë¹„ìŠ¤/ì¿ í°)</div>
        </div>

        <div class="reward-card">
          <div class="reward-top">
            <strong>ì •ë‹µ 2íšŒ</strong>
            <span class="reward-badge">ê°•ë ¥</span>
          </div>
          <div class="reward-desc">ğŸ¥‡ ê°•ë ¥ í˜œíƒ (ì˜ˆ: ì¸ê¸° ë©”ë‰´/ì‚¬ì´ë“œ)</div>
        </div>

        <div class="reward-card">
          <div class="reward-top">
            <strong>ì •ë‹µ 1íšŒ</strong>
            <span class="reward-badge">ê¸°ë³¸</span>
          </div>
          <div class="reward-desc">ğŸ¥ˆ ê¸°ë³¸ í˜œíƒ (ì˜ˆ: ì†Œì†Œ ì¿ í°)</div>
        </div>

        <div class="reward-card">
          <div class="reward-top">
            <strong>ì •ë‹µ 0íšŒ</strong>
            <span class="reward-badge">ì°¸ì—¬</span>
          </div>
          <div class="reward-desc">ğŸ˜… ì°¸ì—¬ ê°ì‚¬ (ì˜ˆ: ìŠ¤íƒ¬í”„/ë‹¤ìŒ ê¸°íšŒ)</div>
        </div>
      </div>

      <div class="summary" aria-label="í˜„ì¬ ì§„í–‰ ìš”ì•½">
        <div class="row">
          <div>í˜„ì¬ íšŒì°¨</div>
          <div><strong><span id="sumRound">0</span></strong>/3</div>
        </div>
        <div class="row">
          <div>ëˆ„ì  ì •ë‹µ</div>
          <div><strong><span id="sumCorrect">0</span></strong>íšŒ</div>
        </div>
        <div class="row">
          <div>ë‚¨ì€ ê¸°íšŒ</div>
          <div><strong><span id="sumLeft">3</span></strong>íšŒ</div>
        </div>
        <div class="final" id="sumHint">
          ì§€ê¸ˆì€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. 3íšŒ ì¢…ë£Œ í›„ ìµœì¢… ê²°ê³¼ê°€ í™•ì •ë©ë‹ˆë‹¤.
        </div>
      </div>

      <!-- âœ… ìš”ì²­: ê´€ë¦¬ì í™•ì¸/ì œì¶œí•˜ê¸° ë²„íŠ¼ -->
      <div class="admin-actions" aria-label="ê´€ë¦¬ì í™•ì¸">
        <button type="button" class="btn primary" id="adminSubmitBtn" disabled>
          ê´€ë¦¬ì í™•ì¸/ì œì¶œí•˜ê¸° âœ…
        </button>
        <div class="admin-note" id="adminNote">* 3íšŒ ì¢…ë£Œ í›„ í™œì„±í™”ë©ë‹ˆë‹¤.</div>
      </div>
    </div>

    <!-- âœ… Modal -->
    <div class="modal-backdrop" id="resultModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal">
        <div class="modal-head">
          <div class="modal-title">
            <h2 id="modalTitle">ìµœì¢… ê²°ê³¼</h2>
            <p>ê²°ê³¼ í™”ë©´ì„ ì§ì›ì—ê²Œ ë³´ì—¬ì£¼ë©´ í˜œíƒì´ ì ìš©ë©ë‹ˆë‹¤.</p>
          </div>
          <button class="modal-close" type="button" id="modalClose" aria-label="ë‹«ê¸°">ë‹«ê¸° âœ•</button>
        </div>

        <div class="modal-body">
          <div class="result-box">
            <div class="result-top">
              <span class="badge" id="modalBadge">ì •ë‹µ 0/3</span>
              <span class="badge" id="modalLevel">ë‚œì´ë„ ê¸°ë¡: Lv.1â†’Lv.3</span>
            </div>
            <div class="result-text" id="modalText">-</div>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn ghost" id="modalReset">ë‹¤ì‹œ í•˜ê¸° ğŸ”</button>
          <button type="button" class="btn primary" id="modalConfirm">í™•ì¸í–ˆì–´ìš” âœ…</button>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const cups = document.querySelectorAll(".cup");
        const ball = document.getElementById("ball");
        const startButton = document.getElementById("startButton");
        const resetAllButton = document.getElementById("resetAllButton");
        const statusText = document.getElementById("statusText");

        const roundChip = document.getElementById("roundChip");
        const correctChip = document.getElementById("correctChip");
        const leftChip = document.getElementById("leftChip");
        const levelChip = document.getElementById("levelChip");

        // âœ… Summary (below box)
        const sumRound = document.getElementById("sumRound");
        const sumCorrect = document.getElementById("sumCorrect");
        const sumLeft = document.getElementById("sumLeft");
        const sumHint = document.getElementById("sumHint");

        // âœ… Admin submit
        const adminSubmitBtn = document.getElementById("adminSubmitBtn");
        const adminNote = document.getElementById("adminNote");

        // âœ… Modal refs
        const resultModal = document.getElementById("resultModal");
        const modalClose = document.getElementById("modalClose");
        const modalReset = document.getElementById("modalReset");
        const modalConfirm = document.getElementById("modalConfirm");
        const modalBadge = document.getElementById("modalBadge");
        const modalLevel = document.getElementById("modalLevel");
        const modalText = document.getElementById("modalText");

        const slotPositions = ["20%", "50%", "80%"];

        const MAX_ROUNDS = 3;
        let roundsPlayed = 0;
        let correctCount = 0;

        let winningCupId = null;
        let isShuffling = false;
        let canPick = false;
        let slotToCup = [0, 1, 2];

        const DIFFICULTY = [
          null,
          { name: "Lv.1", swaps: 6,  tick: 320, lift: 10, fakeChance: 0.00 },
          { name: "Lv.2", swaps: 9,  tick: 260, lift: 12, fakeChance: 0.12 },
          { name: "Lv.3", swaps: 12, tick: 220, lift: 14, fakeChance: 0.22 },
        ];

        function currentLevel(){
          const r = Math.min(MAX_ROUNDS, roundsPlayed + 1);
          return DIFFICULTY[r];
        }

        function getPrizeText(score){
          if (score === 3) return "ğŸ† í¼í™íŠ¸: ìµœê³ ê¸‰ í˜œíƒ (ì˜ˆ: í”„ë¦¬ë¯¸ì—„ ì„œë¹„ìŠ¤/ì¿ í°)";
          if (score === 2) return "ğŸ¥‡ 2íšŒ ì •ë‹µ: ê°•ë ¥ í˜œíƒ (ì˜ˆ: ì¸ê¸° ë©”ë‰´/ì‚¬ì´ë“œ)";
          if (score === 1) return "ğŸ¥ˆ 1íšŒ ì •ë‹µ: ê¸°ë³¸ í˜œíƒ (ì˜ˆ: ì†Œì†Œ ì¿ í°)";
          return "ğŸ˜… 0íšŒ ì •ë‹µ: ì°¸ì—¬ ê°ì‚¬ (ì˜ˆ: ìŠ¤íƒ¬í”„/ë‹¤ìŒ ê¸°íšŒ)";
        }

        function updateAdminButton(){
          const done = roundsPlayed >= MAX_ROUNDS;
          adminSubmitBtn.disabled = !done;
          adminNote.textContent = done ? "* ë²„íŠ¼ì„ ëˆŒëŸ¬ ì§ì›ì—ê²Œ í™•ì¸ë°›ìœ¼ì„¸ìš”." : "* 3íšŒ ì¢…ë£Œ í›„ í™œì„±í™”ë©ë‹ˆë‹¤.";
        }

        function updateSummary(){
          sumRound.textContent = String(roundsPlayed);
          sumCorrect.textContent = String(correctCount);
          sumLeft.textContent = String(Math.max(0, MAX_ROUNDS - roundsPlayed));

          if (roundsPlayed >= MAX_ROUNDS){
            sumHint.innerHTML = `âœ… <strong>3íšŒ ì¢…ë£Œ</strong> Â· ìµœì¢… ìƒí’ˆ: <strong>${getPrizeText(correctCount)}</strong>`;
          } else {
            const lvl = currentLevel()?.name || "-";
            sumHint.innerHTML = `ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ë‹¤ìŒ íšŒì°¨ ë‚œì´ë„ëŠ” <strong>${lvl}</strong> ì…ë‹ˆë‹¤.`;
          }
        }

        function updateChips(){
          roundChip.textContent = String(roundsPlayed);
          correctChip.textContent = String(correctCount);
          leftChip.textContent = String(Math.max(0, MAX_ROUNDS - roundsPlayed));
          levelChip.textContent = (roundsPlayed >= MAX_ROUNDS) ? "-" : currentLevel().name;

          updateSummary();
          updateAdminButton();
        }

        function lockCups(lock){
          cups.forEach(c => c.classList.toggle("is-disabled", lock));
        }

        function clearCupFX(){
          cups.forEach(cup => cup.classList.remove("reveal","is-highlight"));
          ball.classList.remove("visible");
        }

        function initPositions(){
          cups.forEach((cup, idx) => {
            cup.style.left = slotPositions[idx];
            cup.style.transform = "translateX(-50%)";
          });
          clearCupFX();
        }

        function resetRoundState(){
          isShuffling = false;
          canPick = false;
          slotToCup = [0, 1, 2];
          winningCupId = null;
          initPositions();
          lockCups(false);
        }

        function resetAll(){
          roundsPlayed = 0;
          correctCount = 0;
          resetRoundState();
          updateChips();
          startButton.disabled = false;
          startButton.textContent = "ë¼ìš´ë“œ ì‹œì‘ ğŸ©";
          statusText.innerHTML =
            "<strong>ë¼ìš´ë“œ ì‹œì‘</strong>ì„ ëˆ„ë¥´ë©´ ê³µ ìœ„ì¹˜ë¥¼ ì ê¹ ê³µê°œí•œ ë’¤ ì„ìŠµë‹ˆë‹¤.";
        }

        /* =======================
           Modal
        ======================= */
        let lastFocusEl = null;

        function openModal(){
          lastFocusEl = document.activeElement;
          resultModal.classList.add("is-open");
          setTimeout(() => modalConfirm.focus(), 0);
        }

        function closeModal(){
          resultModal.classList.remove("is-open");
          if (lastFocusEl && typeof lastFocusEl.focus === "function") lastFocusEl.focus();
        }

        resultModal.addEventListener("click", (e) => {
          if (e.target === resultModal) closeModal();
        });

        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && resultModal.classList.contains("is-open")) closeModal();
        });

        modalClose.addEventListener("click", closeModal);
        modalConfirm.addEventListener("click", closeModal);
        modalReset.addEventListener("click", () => { closeModal(); resetAll(); });

        function showFinalModal(){
          const prize = getPrizeText(correctCount);
          modalBadge.textContent = `ì •ë‹µ ${correctCount}/3`;
          modalLevel.textContent = `ë‚œì´ë„ ê¸°ë¡: Lv.1 â†’ Lv.2 â†’ Lv.3`;
          modalText.innerHTML =
            `âœ… <strong>3íšŒ ì¢…ë£Œ!</strong> ì´ <strong>${correctCount}</strong>íšŒ ì •ë‹µì…ë‹ˆë‹¤.<br/>` +
            `<strong>ìµœì¢… ìƒí’ˆ:</strong> ${prize}<br/>` +
            `ğŸ“Œ ì´ í™”ë©´ì„ ì§ì›ì—ê²Œ ë³´ì—¬ì£¼ì„¸ìš”.`;
          openModal();
        }

        /* =======================
           Game flow
        ======================= */
        function revealBallThenShuffle(){
          winningCupId = Math.floor(Math.random() * 3);
          const winningCupEl = document.querySelector(`.cup[data-id="${winningCupId}"]`);

          const leftPos = winningCupEl.style.left || slotPositions[winningCupId];
          ball.style.left = leftPos;

          winningCupEl.classList.add("reveal", "is-highlight");
          ball.classList.add("visible");

          statusText.innerHTML = "ğŸ‘€ ê³µ ìœ„ì¹˜ë¥¼ ê¸°ì–µí•˜ì„¸ìš”! ì ì‹œ í›„ ì»µì„ ì„ìŠµë‹ˆë‹¤...";

          setTimeout(() => {
            ball.classList.remove("visible");
            setTimeout(() => {
              winningCupEl.classList.remove("reveal");
              setTimeout(() => winningCupEl.classList.remove("is-highlight"), 120);
              startShuffling();
            }, 180);
          }, 850);
        }

        function startShuffling(){
          const lvl = currentLevel();

          isShuffling = true;
          canPick = false;
          startButton.disabled = true;
          lockCups(true);

          statusText.innerHTML = `ì„ëŠ” ì¤‘ì…ë‹ˆë‹¤... (${lvl.name}) ëˆˆì„ ë–¼ì§€ ë§ˆì„¸ìš” ğŸ‘€`;

          const totalSteps = lvl.swaps;
          let step = 0;

          function doFake(){
            const a = Math.floor(Math.random() * 3);
            const b = (Math.random() < 0.45) ? null : ((a + 1 + Math.floor(Math.random()*2)) % 3);

            const cupIdA = slotToCup[a];
            const cupElA = document.querySelector(`.cup[data-id="${cupIdA}"]`);
            cupElA.style.transform = `translate(-50%, -${lvl.lift}px)`;

            let cupElB = null;
            if (b !== null){
              const cupIdB = slotToCup[b];
              cupElB = document.querySelector(`.cup[data-id="${cupIdB}"]`);
              cupElB.style.transform = `translate(-50%, -${lvl.lift}px)`;
            }

            setTimeout(() => {
              cupElA.style.transform = "translate(-50%, 0)";
              if (cupElB) cupElB.style.transform = "translate(-50%, 0)";
            }, Math.max(140, lvl.tick - 60));
          }

          function doSwap(){
            if (step >= totalSteps){
              isShuffling = false;
              canPick = true;
              lockCups(false);
              startButton.disabled = true;
              statusText.innerHTML = "ì–´ë””ì— ìˆ¨ì—ˆì„ê¹Œìš”? ì»µ í•˜ë‚˜ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”.";
              return;
            }

            if (Math.random() < lvl.fakeChance){
              doFake();
              step++;
              setTimeout(doSwap, lvl.tick);
              return;
            }

            let s1 = Math.floor(Math.random() * 3);
            let s2;
            do { s2 = Math.floor(Math.random() * 3); } while (s2 === s1);

            const cupId1 = slotToCup[s1];
            const cupId2 = slotToCup[s2];

            const cupEl1 = document.querySelector(`.cup[data-id="${cupId1}"]`);
            const cupEl2 = document.querySelector(`.cup[data-id="${cupId2}"]`);

            cupEl1.style.transform = `translate(-50%, -${lvl.lift}px)`;
            cupEl2.style.transform = `translate(-50%, -${lvl.lift}px)`;

            setTimeout(() => {
              cupEl1.style.left = slotPositions[s2];
              cupEl2.style.left = slotPositions[s1];
            }, 70);

            setTimeout(() => {
              cupEl1.style.transform = "translate(-50%, 0)";
              cupEl2.style.transform = "translate(-50%, 0)";
            }, Math.max(170, lvl.tick - 70));

            const temp = slotToCup[s1];
            slotToCup[s1] = slotToCup[s2];
            slotToCup[s2] = temp;

            step++;
            setTimeout(doSwap, lvl.tick);
          }

          setTimeout(doSwap, 220);
        }

        function revealResult(chosenId){
          canPick = false;

          const winningCupEl = document.querySelector(`.cup[data-id="${winningCupId}"]`);
          const winningLeft = winningCupEl.style.left || slotPositions[1];

          ball.style.left = winningLeft;
          winningCupEl.classList.add("reveal", "is-highlight");
          ball.classList.add("visible");

          lockCups(true);

          const isCorrect = (chosenId === winningCupId);
          if (isCorrect) correctCount++;

          roundsPlayed++;
          updateChips();

          statusText.innerHTML = isCorrect
            ? `ğŸ‰ <strong>ì •ë‹µ!</strong> (${roundsPlayed}/3) ì§€ê¸ˆê¹Œì§€ <strong>${correctCount}</strong>íšŒ ì„±ê³µ!`
            : `ğŸ˜¢ ì•„ì‰½! (${roundsPlayed}/3) ì§€ê¸ˆê¹Œì§€ <strong>${correctCount}</strong>íšŒ ì„±ê³µ!`;

          startButton.disabled = false;
          startButton.textContent = (roundsPlayed >= MAX_ROUNDS)
            ? "ìµœì¢… ê²°ê³¼ ë³´ê¸° ğŸ"
            : `ë‹¤ìŒ ë¼ìš´ë“œ (${roundsPlayed+1}/3) â–¶`;
        }

        cups.forEach((cup) => {
          cup.addEventListener("click", () => {
            if (!canPick || isShuffling) return;
            const id = parseInt(cup.dataset.id, 10);
            revealResult(id);
          });
        });

        startButton.addEventListener("click", () => {
          if (roundsPlayed >= MAX_ROUNDS){
            showFinalModal();
            return;
          }

          resetRoundState();
          startButton.disabled = true;
          startButton.textContent = "ì„ëŠ” ì¤‘... ğŸ©";

          const lvl = currentLevel();
          statusText.innerHTML =
            `<strong>${roundsPlayed+1}íšŒì°¨</strong> ì‹œì‘! ë‚œì´ë„ <strong>${lvl.name}</strong> â€” ê³µ ìœ„ì¹˜ë¥¼ ì ê¹ ê³µê°œí•©ë‹ˆë‹¤.`;

          revealBallThenShuffle();
          updateChips();
        });

        resetAllButton.addEventListener("click", resetAll);

        // âœ… ê´€ë¦¬ì ì œì¶œ ë²„íŠ¼ ë™ì‘(ë°ëª¨)
        adminSubmitBtn.addEventListener("click", () => {
          if (adminSubmitBtn.disabled) return;
          alert(`ì œì¶œ ì™„ë£Œ âœ…\n- ì •ë‹µ: ${correctCount}/3\n- ìµœì¢… ìƒí’ˆ: ${getPrizeText(correctCount)}\nì§ì›ì—ê²Œ í™”ë©´ì„ ë³´ì—¬ì£¼ì„¸ìš”.`);
        });

        // init
        resetAll();
      })();
    </script>
  </body>
</html>
