<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ì‚¬ë‹¤ë¦¬ íƒ€ê¸° (í•˜ë“œ ëª¨ë“œ)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }

      body{
        min-height:100vh;
        display:grid;
        place-items:center;
        gap:12px;
        padding: 16px;
        background:#f7f2ea;
        font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
        color:#3a2415;
      }

      /* âœ… Fixed canvas: 600x450 */
      .game-shell{
        width:600px;
        height:450px;
        padding: 14px 14px 12px;
        background:#fffaf5;
        border-radius:24px;
        border:1px solid rgba(193,160,120,.6);
        box-shadow:0 16px 40px rgba(120,72,37,.18);
        overflow:hidden;

        display:grid;
        grid-template-rows: auto auto auto 1fr auto;
        gap:10px;
      }

      .game-header{ text-align:center; }
      .game-title{ font-size:18px; font-weight:950; letter-spacing:-.03em; margin-bottom:4px; }
      .game-sub{ font-size:12px; color:#6b4a30; line-height:1.4; }

      .actions{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        justify-content:space-between; /* âœ… ì˜¤ë¥¸ìª½ ë ë°°ì¹˜ */
        align-items:center;
      }
      .actions-left{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
      }

      .btn{
        border-radius:999px;
        padding:9px 12px;
        font-size:12px;
        border:1px solid rgba(148,104,63,.7);
        background:#fff;
        color:#3a2415;
        font-weight:900;
        cursor:pointer;
        display:inline-flex; align-items:center; gap:8px;
        transition:.15s ease;
        white-space:nowrap;
      }
      .btn.primary{
        background: linear-gradient(120deg, #f97316, #fbbf24);
        border-color: transparent;
        color:#3b1f0a;
        box-shadow: 0 10px 22px rgba(201,93,39,.45);
      }
      .btn:hover:not([disabled]){ transform: translateY(-1px); }
      .btn[disabled]{ opacity:.55; cursor:default; transform:none; box-shadow:none; }

      .counters{
        display:flex;
        gap:8px;
        flex-wrap:wrap;
        align-items:center;
        justify-content:center;
      }
      .pill{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:8px 10px;
        border-radius:999px;
        background: rgba(255,255,255,.85);
        border: 1px solid rgba(193,160,120,.55);
        font-size:12px;
        color:#6b4a30;
        white-space:nowrap;
      }
      .pill strong{ color:#b45309; }

      .pick-row{
        display:grid;
        grid-template-columns: repeat(6, 1fr);
        gap:8px;
      }
      .pick-btn{
        border-radius:999px;
        padding:9px 10px;
        font-size:12px;
        border:1px solid rgba(148,104,63,.7);
        background:#fff;
        color:#3a2415;
        font-weight:950;
        cursor:pointer;
        transition:.15s ease;
        text-align:center;
      }
      .pick-btn:hover:not([disabled]){ transform: translateY(-1px); }
      .pick-btn[disabled]{ opacity:.55; cursor:default; transform:none; }

      .board{
        border-radius:18px;
        background: radial-gradient(circle at top, #f4e4cf, #e2c6a7);
        box-shadow: inset 0 3px 6px rgba(255,255,255,.6);
        padding:12px;
        position:relative;
        min-height:0;
        display:grid;
        grid-template-rows: 1fr;
      }

      .canvas-scroll{
        height: 240px;
        overflow:auto;
        border-radius:14px;
        background: rgba(255,255,255,.55);
        border: 1px solid rgba(193,160,120,.55);
        padding: 10px;
      }
      canvas{
        width:100%;
        height:auto;
        display:block;
        border-radius:12px;
        background:#151515;
      }

      /* âœ… info box (game-shell ì•„ë˜) */
      .info-shell{
        width:600px;
        background: rgba(255,250,245,.9);
        border-radius:18px;
        border:1px solid rgba(193,160,120,.45);
        box-shadow: 0 10px 26px rgba(120,72,37,.10);
        padding:12px;
        display:grid;
        gap:10px;
      }

      .info-head{
        display:flex;
        align-items:flex-end;
        justify-content:space-between;
        gap:10px;
        flex-wrap:wrap;
      }
      .info-head h3{
        font-size:13px;
        font-weight:950;
        letter-spacing:-.02em;
      }

      .prize-list{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:8px;
        font-size:12px;
        color:#6b4a30;
      }
      .prize-item{
        display:flex; align-items:center; justify-content:space-between;
        background:#fff;
        border:1px solid rgba(193,160,120,.45);
        border-radius:12px;
        padding:9px 10px;
        gap:10px;
      }
      .prize-item strong{ color:#3a2415; }
      .badge{
        font-size:11px; padding:6px 10px; border-radius:999px;
        border:1px solid rgba(193,160,120,.6);
        background:#faf6f0;
        color:#6b4a30;
        white-space:nowrap;
      }

      .result{
        padding:12px 12px;
        border-radius:16px;
        background:#fff;
        border:1px solid rgba(193,160,120,.55);
        font-size:12.5px;
        color:#6b4a30;
        line-height:1.55;
        min-height:52px;
      }
      .result strong{ color:#b45309; }

      @media (max-width: 640px){
        .game-shell, .info-shell{ width: 100%; }
        .game-shell{ height:auto; min-height:450px; }
        .prize-list{ grid-template-columns: 1fr; }
        .pick-row{ grid-template-columns: 1fr 1fr; }
        .actions{ justify-content: center; } /* ëª¨ë°”ì¼ì€ ê°€ìš´ë° ì •ë ¬ */
      }
    </style>
  </head>

  <body>
    <div class="game-shell">
      <header class="game-header">
        <h1 class="game-title">ì‚¬ë‹¤ë¦¬ íƒ€ê¸°</h1>
        <p class="game-sub">
          STARTë¥¼ ì„ íƒí•˜ë©´ ì¦‰ì‹œ ê²½ë¡œê°€ ì§„í–‰ë˜ê³ , ë„ì°©í•œ ENDì— ë”°ë¼ ê²°ê³¼ê°€ ê²°ì •ë©ë‹ˆë‹¤.
        </p>
      </header>

      <div class="actions">
        <!-- âœ… ì™¼ìª½ ê·¸ë£¹ -->
        <div class="actions-left">
          <button class="btn primary" id="regenBtn">ì‚¬ë‹¤ë¦¬ ìƒˆë¡œ ë§Œë“¤ê¸° ğŸ”</button>

          <div class="counters" aria-label="ì¹´ìš´í„°">
            <span class="pill">ìƒˆë¡œ ë§Œë“¤ê¸° <strong id="regenCount">0</strong>íšŒ</span>
            <span class="pill">ì‚¬ë‹¤ë¦¬ íƒ€ê¸° <strong id="playCount">0</strong>íšŒ</span>
          </div>
        </div>

        <!-- âœ… ì˜¤ë¥¸ìª½ ë: ê´€ë¦¬ì ë²„íŠ¼ -->
        <button class="btn" id="adminSubmitBtn" disabled>ê´€ë¦¬ì í™•ì¸/ì œì¶œí•˜ê¸° âœ…</button>
      </div>

      <div class="pick-row" id="pickRow" aria-label="START ì„ íƒ">
        <button class="pick-btn" data-start="0">START 1</button>
        <button class="pick-btn" data-start="1">START 2</button>
        <button class="pick-btn" data-start="2">START 3</button>
        <button class="pick-btn" data-start="3">START 4</button>
        <button class="pick-btn" data-start="4">START 5</button>
        <button class="pick-btn" data-start="5">START 6</button>
      </div>

      <section class="board" aria-label="ì‚¬ë‹¤ë¦¬ ë³´ë“œ">
        <div class="canvas-scroll" id="canvasScroll">
          <canvas id="ladderCanvas" width="1100" height="1600"></canvas>
        </div>
      </section>
    </div>

    <div class="info-shell" aria-label="ê²°ê³¼ ë° ë³´ìƒ">
      <div class="info-head">
        <h3>ì§„í–‰ìƒí™©</h3>
      </div>
      <div class="result" id="resultBox">
        STARTë¥¼ ì„ íƒí•´ ê²Œì„ì„ ì§„í–‰í•˜ì„¸ìš”.
      </div>

      <div class="info-head">
        <h3>ê²°ê³¼ ë° ë³´ìƒ ì•ˆë‚´</h3>
      </div>
      <div class="prize-list" id="prizeList"></div>
    </div>

    <script>
      (() => {
        const COLS = 6;
        const ROWS = 32;
        const RUNG_DENSITY = 0.68;
        const MAX_PLAY_PER_LADDER = 1;

        // âœ… ì†ë„ ì¡°ê¸ˆ ëŠë¦¬ê²Œ
        const ANIM_MS = 3200;

        const MARGIN_X = 90;
        const TOP_Y = 55;
        const BOTTOM_Y = 1520;

        const prizesByEndCol = [
          { title: "ìº” ìŒë£Œ 1ê°œ", badge: "ì†Œì†Œ" },
          { title: "ë©´ë¥˜ 1ì ‘ì‹œ", badge: "ì¸ê¸°" },
          { title: "í¬ì¼“ í•«íŒ©", badge: "êµ¿ì¦ˆ" },
          { title: "ë‹¹ì¼ 5,000ì› í• ì¸", badge: "í• ì¸" },
          { title: "ë‹¤ìŒ ë°©ë¬¸ 30% í• ì¸", badge: "ì¬ë°©ë¬¸" },
          { title: "ë‹¤ìŒ ë°©ë¬¸ 50% í• ì¸", badge: "ëŒ€ë°•" },
        ];

        const canvas = document.getElementById("ladderCanvas");
        const ctx = canvas.getContext("2d");

        const pickRow = document.getElementById("pickRow");
        const pickButtons = pickRow.querySelectorAll(".pick-btn");

        const prizeList = document.getElementById("prizeList");
        const resultBox = document.getElementById("resultBox");

        const regenBtn = document.getElementById("regenBtn");
        const canvasScroll = document.getElementById("canvasScroll");

        // âœ… ê´€ë¦¬ì ë²„íŠ¼
        const adminSubmitBtn = document.getElementById("adminSubmitBtn");

        // âœ… ì¹´ìš´í„°
        const regenCountEl = document.getElementById("regenCount");
        const playCountEl = document.getElementById("playCount");
        let regenCount = 0;
        let playCount = 0;

        let rungs = [];
        let animating = false;

        // âœ… ì œì¶œ ë°ì´í„°(ë°ëª¨)
        let lastResult = null; // { startCol, endCol, prizeTitle, badge }

        function updatePickAvailability(){
          const canPlay = playCount < MAX_PLAY_PER_LADDER && !animating;
          pickButtons.forEach(btn => btn.disabled = !canPlay);
        }

        function updateAdminAvailability(){
          // í”Œë ˆì´ ê²°ê³¼ê°€ ìˆê³ , ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ í™œì„±
          adminSubmitBtn.disabled = !(lastResult && !animating);
        }

        function drawPrizeList(){
          prizeList.innerHTML = "";
          prizesByEndCol.forEach((p, i) => {
            const el = document.createElement("div");
            el.className = "prize-item";
            el.innerHTML = `
              <div><strong>END ${i+1}</strong> Â· ${p.title}</div>
              <div class="badge">${p.badge}</div>
            `;
            prizeList.appendChild(el);
          });
        }

        function lerp(a,b,t){ return a + (b-a)*t; }

        function getColX(col){
          const usable = canvas.width - MARGIN_X * 2;
          const step = usable / (COLS - 1);
          return MARGIN_X + step * col;
        }

        function getRowY(rowIndex){
          const usable = BOTTOM_Y - TOP_Y;
          const step = usable / ROWS;
          return TOP_Y + step * rowIndex;
        }

        function generateLadder(){
          rungs = Array.from({length: ROWS + 1}, () => new Set());
          for(let r=1; r<=ROWS; r++){
            const used = new Set();
            for(let i=0; i<COLS-1; i++){
              if (used.has(i) || used.has(i-1) || used.has(i+1)) continue;
              if (Math.random() < RUNG_DENSITY) {
                rungs[r].add(i);
                used.add(i);
              }
            }
          }
        }

        function drawStatic(){
          ctx.clearRect(0,0,canvas.width,canvas.height);

          ctx.fillStyle = "#151515";
          ctx.fillRect(0,0,canvas.width,canvas.height);

          ctx.font = "800 14px system-ui, -apple-system, Segoe UI, sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";

          for(let c=0; c<COLS; c++){
            const x = getColX(c);
            ctx.fillStyle = "rgba(255,255,255,0.90)";
            ctx.fillText(`START ${c+1}`, x, TOP_Y - 22);

            ctx.fillStyle = "rgba(255,255,255,0.78)";
            ctx.fillText(`END ${c+1}`, x, BOTTOM_Y + 22);
          }

          ctx.lineWidth = 6;
          ctx.lineCap = "round";
          ctx.strokeStyle = "rgba(255,255,255,0.82)";
          for(let c=0; c<COLS; c++){
            const x = getColX(c);
            ctx.beginPath();
            ctx.moveTo(x, TOP_Y);
            ctx.lineTo(x, BOTTOM_Y);
            ctx.stroke();
          }

          ctx.lineWidth = 6;
          ctx.strokeStyle = "rgba(249, 115, 22, 0.95)";
          for(let r=1; r<=ROWS; r++){
            const y = getRowY(r);
            for(const link of rungs[r]){
              const x1 = getColX(link);
              const x2 = getColX(link+1);
              ctx.beginPath();
              ctx.moveTo(x1, y);
              ctx.lineTo(x2, y);
              ctx.stroke();
            }
          }
        }

        function buildPathPoints(startCol){
          const pts = [];
          let col = startCol;

          pts.push({x:getColX(col), y: TOP_Y});

          for(let r=1; r<=ROWS; r++){
            const y = getRowY(r);
            pts.push({x:getColX(col), y});

            if (rungs[r].has(col)) {
              col = col + 1;
              pts.push({x:getColX(col), y});
            } else if (rungs[r].has(col-1)) {
              col = col - 1;
              pts.push({x:getColX(col), y});
            }
          }

          pts.push({x:getColX(col), y: BOTTOM_Y});
          return { points: pts, endCol: col };
        }

        function polylineLength(points){
          let total = 0;
          for(let i=0;i<points.length-1;i++){
            total += Math.hypot(points[i+1].x - points[i].x, points[i+1].y - points[i].y);
          }
          return total;
        }

        function getMarker(points, t){
          const total = polylineLength(points);
          const target = total * t;
          let acc = 0;

          for(let i=0;i<points.length-1;i++){
            const a = points[i], b = points[i+1];
            const seg = Math.hypot(b.x - a.x, b.y - a.y);
            if (acc + seg >= target){
              const ratio = seg === 0 ? 1 : (target - acc) / seg;
              return { x: lerp(a.x,b.x,ratio), y: lerp(a.y,b.y,ratio) };
            }
            acc += seg;
          }
          return points[points.length-1];
        }

        function drawPathProgress(points, t){
          const total = polylineLength(points);
          const target = total * t;

          ctx.lineWidth = 9;
          ctx.lineCap = "round";
          ctx.strokeStyle = "rgba(250, 204, 21, 0.95)";
          ctx.beginPath();

          let acc = 0;
          ctx.moveTo(points[0].x, points[0].y);

          for(let i=0;i<points.length-1;i++){
            const a = points[i], b = points[i+1];
            const seg = Math.hypot(b.x - a.x, b.y - a.y);

            if (acc + seg <= target){
              ctx.lineTo(b.x, b.y);
              acc += seg;
            } else {
              const remain = target - acc;
              const ratio = seg === 0 ? 1 : Math.max(0, Math.min(1, remain / seg));
              ctx.lineTo(lerp(a.x,b.x,ratio), lerp(a.y,b.y,ratio));
              break;
            }
          }
          ctx.stroke();

          const marker = getMarker(points, t);
          if (marker){
            ctx.fillStyle = "rgba(255,255,255,0.92)";
            ctx.beginPath();
            ctx.arc(marker.x, marker.y, 7, 0, Math.PI*2);
            ctx.fill();
          }
          return marker;
        }

        function showResult(endCol, startCol){
          const prize = prizesByEndCol[endCol];
          resultBox.innerHTML =
            `START <strong>${startCol+1}</strong> â†’ END <strong>${endCol+1}</strong><br>` +
            `ê²°ê³¼: <strong>${prize.title}</strong> <span style="color:#8b6544;">(${prize.badge})</span>`;

          lastResult = {
            startCol,
            endCol,
            prizeTitle: prize.title,
            badge: prize.badge
          };
          updateAdminAvailability();
        }

        // âœ… ì§„í–‰ ìƒí™©ì— ë§ì¶° ìŠ¤í¬ë¡¤ ë”°ë¼ê°€ê¸°
        function followScroll(markerYCanvas){
          if (!markerYCanvas) return;

          const renderedCanvasH = canvas.getBoundingClientRect().height;
          const scale = renderedCanvasH / canvas.height;

          const markerYRendered = markerYCanvas * scale;

          const offset = canvasScroll.clientHeight * 0.35;
          const desired = markerYRendered - offset;

          const maxScroll = canvasScroll.scrollHeight - canvasScroll.clientHeight;
          const next = Math.max(0, Math.min(maxScroll, desired));

          canvasScroll.scrollTop = canvasScroll.scrollTop + (next - canvasScroll.scrollTop) * 0.18;
        }

        function animatePath(startCol){
          if (animating) return;
          animating = true;

          updatePickAvailability();
          regenBtn.disabled = true;
          updateAdminAvailability();

          const { points, endCol } = buildPathPoints(startCol);
          const start = performance.now();

          const tick = (now) => {
            const p = Math.min(1, (now - start) / ANIM_MS);
            drawStatic();
            const marker = drawPathProgress(points, p);
            followScroll(marker?.y);

            if (p < 1){
              requestAnimationFrame(tick);
            } else {
              animating = false;
              regenBtn.disabled = false;
              updatePickAvailability();
              showResult(endCol, startCol);
              updateAdminAvailability();
            }
          };

          requestAnimationFrame(tick);
        }

        // ===== ì´ë²¤íŠ¸ =====
        pickRow.addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-start]");
          if (!btn) return;
          if (animating) return;
          if (playCount >= MAX_PLAY_PER_LADDER) return;

          const startCol = parseInt(btn.dataset.start, 10);

          playCount += 1;
          playCountEl.textContent = String(playCount);

          updatePickAvailability();
          updateAdminAvailability();

          resultBox.textContent = "ê²½ë¡œë¥¼ ë”°ë¼ ë‚´ë ¤ê°€ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
          canvasScroll.scrollTo({ top: 0, behavior: "smooth" });

          animatePath(startCol);
        });

        regenBtn.addEventListener("click", () => {
          if (animating) return;

          regenCount += 1;
          regenCountEl.textContent = String(regenCount);

          playCount = 0;
          playCountEl.textContent = "0";

          // âœ… ìƒˆ ì‚¬ë‹¤ë¦¬ ë§Œë“¤ë©´ ì œì¶œë„ ë‹¤ì‹œ ë¹„í™œì„±(ê²°ê³¼ ë¬´íš¨)
          lastResult = null;
          updateAdminAvailability();

          generateLadder();
          drawStatic();

          resultBox.textContent = "ìƒˆ ì‚¬ë‹¤ë¦¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. STARTë¥¼ ì„ íƒí•˜ì„¸ìš”.";

          updatePickAvailability();
          canvasScroll.scrollTo({ top: 0, behavior: "smooth" });
        });

        // âœ… ê´€ë¦¬ì ì œì¶œ(ë°ëª¨)
        adminSubmitBtn.addEventListener("click", () => {
          if (!lastResult) return;
          alert(
            `ê´€ë¦¬ì í™•ì¸/ì œì¶œ âœ…\n\n` +
            `START: ${lastResult.startCol + 1}\n` +
            `END: ${lastResult.endCol + 1}\n` +
            `ê²°ê³¼: ${lastResult.prizeTitle} (${lastResult.badge})\n\n` +
            `â€» ìš´ì˜ ì—°ë™ ì‹œ ì„œë²„/QR/ì¿ í° ë°œê¸‰ìœ¼ë¡œ ì—°ê²°`
          );

          fetch("https://jsonplaceholder.typicode.com/posts", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              title: "API í…ŒìŠ¤íŠ¸ ì œëª©",
              body: "í”„ë¡ íŠ¸ì—”ë“œì—ì„œ POST í˜¸ì¶œ í…ŒìŠ¤íŠ¸ ì¤‘ì…ë‹ˆë‹¤.",
              userId: 1
            })
          })
          .then(res => res.json())
          .then(data => {
            console.log("ì‘ë‹µ:", data);
            if (data.userId == 1) alert("ì„±ê³µ");
            else alert("ì‹¤íŒ¨");
          })
          .catch(err => console.error(err));


        });

        // ===== ì´ˆê¸°í™” =====
        drawPrizeList();
        generateLadder();
        drawStatic();
        regenCountEl.textContent = "0";
        playCountEl.textContent = "0";
        updatePickAvailability();
        updateAdminAvailability();
      })();
    </script>
  </body>
</html>
